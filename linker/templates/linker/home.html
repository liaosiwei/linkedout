{% extends "linker/base.html" %} 
{% load staticfiles %} 
{% load linker_extras %}
{% block css %}
	<link href="{% static 'linker/css/jquery-ui.css' %}" rel="stylesheet">
	<style type="text/css">
		td.tablerow {
			position: relative;
			top: 6px;
		}
      	#favicon {
      		position: relative; 
      		top: -2px; 
      		witdth: 40px; height: 14px;
      	}
      	#create-link {
      		position: absolute; 
      		right: 160px; top: 200px;
      	}
      	#link-trash {
      		position: fixed;
      		position: absolute; right: 170px; bottom: 230px;
      		width: 40px; height: 40px;
      	}
      	#effect { 
      		width: 200px; height: 60px; 
      		padding: 0.4em; position: absolute; 
      		right: 80px; bottom: 280px; 
      		text-align: center;
      	}
      	#effect h3 { 
      		margin: 0;  
      		font-size: 1.2em; 
      		text-align: center; 
      	}
      	.container hr {
      		/* border-color: #7D7D7D; */
      		border-color: #CFCFCF;
      		margin: 1px, 0;
      	}
      }
  	</style>
{% endblock %} 
{% block content %}
	{% if user.is_authenticated %}
	<h4><a href="downloadXml"><i class="icon-download-alt"></i>download your file</a></h4>
	<div>
		{% for container in container_list %}
			<h3>{{ container.name }}</h3>
			<div>
				<table class="table">
					{% for link in container.linker_set.all|dictsort:"id"|filterDeletedLinks %}
							{% if forloop.counter0|divisibleby:"4" %}
								<tr>
							{% endif %}
								<td class="onelink tablerow span3">
									<img id="favicon" src="{{link.link | getFavicon }}" />
									<a href="{{link.link}}" target="_blank">{{ link.name }}</a>
								</td>
							{% if forloop.counter|divisibleby:"4" %}
								</tr>
							{% elif forloop.last%}
								{% with count=forloop.counter %}
									{% for i in count|fillTableTd:"4" %}
										<td class="onelink tablerow span3"></td>
									{% endfor %}
								{% endwith %}
								</tr>
							{% endif %}
					{% endfor %}
				</table>
				{% if not forloop.last %}
					<hr>
				{% endif %}
			</div>
		{% endfor %}
	</div>
	{% else %}
	<h1>欢迎</h1>
	<p>没有账号<a href="auths/register"><strong>请注册</strong></a>，登陆后可以使用个性化书签设置</p>
	
	<div>
		<h3>
			<strong>常用网站</strong>
		</h3>
		<div>
			<p>
				<a href="http://www.baidu.com" target="_blank">百度</a>
			</p>
		</div>
	</div>
	{% endif %}
	<div id="dialog-form" title="新建书签">
	  <p class="validateTips"></p> 
	  <form>
	  <fieldset>
	  	<label for="container">分类</label>
	    <input type="text" name="container" id="container" />
	    <label for="name">名称</label>
	    <input type="text" name="name" id="name" />
	    <label for="address">网址</label>
	    <input type="text" name="address" id="address" value="" />
	    <label for="tip">说明</label>
	    <input type="text" name="tip" id="tip" value="" />
	  </fieldset>
	  </form>
	</div>
	<button id="create-link"><i class="icon-share-alt"></i></button>
	    
	<div id="effect" class="ui-widget-content ui-corner-all">
	  <h3 class="ui-widget-header">删除书签</h3>
	  <p>将书签拖动到此处即可删除</p>
	</div>
	
	<button id="link-trash"><i class="icon-trash"></i></button>
{% endblock %} 
	
{% block js%}
	<script src="{% static 'linker/js/jquery-ui.js' %}"></script>
	<script src="{% static 'linker/js/addurls.js' %}"></script>
	<script src="{% static 'linker/js/setvalues.js' %}"></script>
	<script>
	  $(document).ready(function() {
  	    
	    $( "#create-link" )
	      .button()
	      .click(function() {
	        $( "#dialog-form" ).dialog( "open" );
	      });
	    
	    $( "td.onelink" ).draggable({
	    	  cursor: "move",
   		      appendTo: "body",
   		      helper: "clone"
	    });
	    
	    function handle_del_url(data) {
	    	window.location = "/";
	    }
	    
	    $( "#link-trash" ).droppable({
	        drop: function(event, ui) {
            	var delData = {};
            	delData['link_container'] = ui.draggable.closest("div").prev("h3").text();
            	delData['link_url'] = ui.draggable.find("a").attr("href");
	            $.ajax({
	            	url:"/ajaxDelUrl/",
	            	type: "POST",
	            	data: delData,
	            	dataType: "json",
	            	success: handle_del_url
	            });
	        }
	      });
	    function runEffect() {
	    	var options = { to: { width: 280, height: 185 } };
	        // run the effect 
	        $( "#effect" ).show( "clip", options, 500, callback );
	      };
	   
	      //callback function to bring a hidden box back 
	    function callback() {
	      setTimeout(function() {
	        $( "#effect:visible" ).fadeOut();
	        }, 1000 );
	    };
	     
	    // set effect from select menu value 
	    $( "#link-trash" ).click(function() {
	       runEffect();
	       return false;
	    });
	    
		// set or reset tips by click the set button 
 		$( ".settips" ).click(function() {
			settipsfunc($(this));
			return false;
		});
		
		// set or reset votes by click the thumb button 
		$( ".setvotes" ).click(function(){		
 			setvotesfunc($(this));
			return false;
		});
	   
	    $( "#effect" ).hide();
	    
	    // juery-ui's auto-complete widget 
	    $("#container").autocomplete({
    	  source: "/autoComplete/",
    	  minLength: 2
	    });
	  })
	</script>
{% endblock %}
